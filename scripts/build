#!/bin/bash
set -e

source $(dirname $0)/version

cd $(dirname $0)/..

OS_ARCH_LINUX="amd64 arm64"

mkdir -p output/bin
if [ -n "$DRONE_TAG" ]; then
    TAG=$DRONE_TAG
fi

for ARCH in ${OS_ARCH_LINUX}; do
        echo Building kubelet-$ARCH
        build/run.sh make kubelet KUBE_BUILD_PLATFORMS=linux/$ARCH
	mv _output/dockerized/bin/linux/$ARCH/kubelet . 
        tar -cvzf output/bin/kubelet-$TAG-$ARCH.tar.gz kubelet && rm kubelet
done

rm -rf _output/

echo Built ${TAG}
